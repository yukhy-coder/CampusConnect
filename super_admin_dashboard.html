<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-red: #960b15; --cream: #fdfcd7; --bg-beige: #fdfae7; --orange-btn: #cf6828; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--bg-beige); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { background: linear-gradient(90deg, #960b15 0%, #70060d 100%); height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; color: white; width: 100%; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .header-left { display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .header-logo { width: 60px; height: 60px;  border-radius: 50%;  overflow: hidden; display: flex; justify-content: center; align-items: center; }
        
        .header-logo img { width: 100%; height: 100%; object-fit: cover; }
        .header-title { font-weight: 600; font-size: 18px; letter-spacing: 0.5px; }
        .header-right { display: flex; align-items: center;  position: relative; }

        .search-bar { background: rgba(255,255,255,0.15); border-radius: 20px; padding: 8px 15px; display: flex; align-items: center; width: 250px; }
        .search-bar input { background: transparent; border: none; color: white; outline: none; width: 100%; margin-left: 10px; }
        .search-bar i { color: white; opacity: 0.8; }
        .profile-icon { width: 35px; height: 35px; background-color: #ff6b6b; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; color:white; cursor: pointer; }

        /* MENUS */
        .main-dropdown-menu, .notif-dropdown { position: absolute; background-color: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); display: none; z-index: 1000; overflow: hidden; top: 52px !important; right: -31px !important; border-top-right-radius: 0px;}
        .main-dropdown-menu { position: absolute; top: 53px; right: -30px; width: 260px; border-radius: 12px; padding: 10px 0; border-top-right-radius: 0px; background-color: white; box-shadow: 0 5px 20px rgba(0,0,0,0.3);}
        .notif-dropdown { top: 60px; right: 80px; width: 350px; }
        .show { display: block !important; animation: fadeIn 0.2s ease-in-out; }
        .menu-item { padding: 12px 20px; display: flex; align-items: center; gap: 15px; color: #333; font-size: 15px; font-weight: 500; cursor: pointer; transition: 0.2s; }
        .menu-item:hover { background-color: #fff5f5; color: var(--primary-red); }
        .notif-header { background-color: var(--primary-red); color: white; padding: 15px; font-weight: bold; font-size: 16px; }
        .notif-list { max-height: 400px; overflow-y: auto; }
        .notif-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; }
        .notif-item:hover { background-color: #f9f9f9; }
        .notif-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: white; font-size: 18px; }
        .icon-msg { background-color: #e86c29; } .icon-evt { background-color: var(--primary-red); }
        .notif-content { flex-grow: 1; }
        .notif-text { font-size: 13px; color: #333; font-weight: 600; line-height: 1.4; }
        .notif-time { font-size: 11px; color: #888; margin-top: 4px; }

        /* PROFILE DRAWER */
        .profile-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; opacity: 0; visibility: hidden; transition: 0.3s; }
        .profile-overlay.open { opacity: 1; visibility: visible; }
        .profile-drawer { position: fixed; top: 0; right: -400px; width: 380px; height: 100%; background: #fff; z-index: 2001; transition: 0.3s ease-in-out; box-shadow: -5px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .profile-drawer.open { right: 0; }
        .profile-drawer-header { background-color: var(--primary-red); height: 200px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; border-bottom-left-radius: 50% 30%; border-bottom-right-radius: 50% 30%; margin-bottom: 40px; }
        .big-profile-icon { width: 100px; height: 100px; background-color: #e53935; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold; color: white; border: 4px solid white; position: absolute; bottom: -50px; }
        .edit-profile-link { margin-top: -20px; font-size: 14px; opacity: 0.8; cursor: pointer; }
        .profile-form { padding: 20px 30px; flex-grow: 1; overflow-y: auto;}
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 14px; color: var(--primary-red); margin-bottom: 5px; font-weight: bold;}
        .input-wrapper { position: relative; }
        .input-wrapper input { width: 100%; padding: 12px 15px; border: 1px solid #ffcccc; background-color: #fff8f8; border-radius: 8px; outline: none; font-size: 14px; color: #333; }
        .input-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--primary-red); font-size: 12px; pointer-events: none; }
        .drawer-actions { display: flex; gap: 15px; margin-top: 30px; }
        .drawer-actions button { flex: 1; padding: 12px; border-radius: 25px; border: none; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .btn-back { background-color: #c62828; color: white; }
        .btn-save { background-color: var(--orange-btn); color: white; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* LAYOUT & SIDEBAR */
        .main-container { display: flex; height: calc(100vh - 70px); }
        .sidebar { min-width: 250px; background-color: #c6363c; color: white; display: flex; flex-direction: column; padding-top: 20px; }
        .nav-item { display: flex; align-items: center; gap: 15px; padding: 15px 25px; cursor: pointer; font-size: 18px; font-weight: 500; transition: 0.2s; text-decoration: none; color: white; }
        .nav-item:hover, .nav-item.active { background-color: #9e1c22; border-left: 5px solid white; }
        .nav-item i { width: 25px; text-align: center; }

        /* CONTENT AREA */
        .content-area { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .page-title { font-size: 28px; font-weight: bold; margin-bottom: 25px; color: #222; }

        /* --- VIEW: DASHBOARD (Stats & Charts) --- */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .stat-icon-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 14px; font-weight: 600; color: #444; }
        .stat-icon { width: 30px; height: 30px; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: #8d3e1e; }
        .icon-officer { background-color: #fdfcd7; color: #cf6828; } .icon-login { background-color: #fdfcd7; color: #cf6828; } .icon-msg { background-color: #fdfcd7; color: #cf6828; } .icon-event { background-color: #fdfcd7; color: #cf6828; }
        .stat-number { font-size: 32px; font-weight: bold; color: #222; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; width: 100%; }
        .chart-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #333; }
        .chart-wrapper { width: 100%; height: 250px; position: relative; }

        /* --- VIEW: OFFICERS (Table & Tabs) --- */
        .search-container { position: relative; width: 100%; max-width: 800px; margin-bottom: 30px; }
        .search-container input { width: 100%; padding: 15px 20px 15px 50px; border-radius: 30px; border: 1px solid #ccc; outline: none; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .search-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); font-size: 20px; color: #333; }
        
        .tabs-container { display: flex; background-color: #e0e0e0; width: fit-content; border-radius: 5px 5px 0 0; overflow: hidden; }
        .tab { padding: 10px 30px; cursor: pointer; font-weight: 600; color: #555; background-color: #e0e0e0; transition: 0.2s; }
        .tab.active { background-color: white; color: #000; }
        
        .officers-table-container { background-color: white; border-radius: 0 5px 5px 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; width: 100%; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        thead { background-color: white; border-bottom: 1px solid #eee; }
        th { padding: 20px; font-weight: 600; color: #333; font-size: 14px; }
        td { padding: 20px; border-bottom: 1px solid #f5f5f5; color: #333; font-size: 14px; vertical-align: middle; }
        .btn-remove { background-color: #e57373; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: 500; transition: 0.2s; width: 87px;}
        .btn-remove:hover { background-color: #d32f2f; }
        .empty-row td { height: 60px; }

        /* LOGS TABLE STYLES (Similar to Officers but Red Header) */
        .logs-table-header {
            background-color: #a60000; /* Dark Red Header */
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
            border-top-left-radius: 8px; border-top-right-radius: 8px;
        }
        .logs-table-header th { color: white; border: none; padding: 15px; text-transform: uppercase; font-size: 12px; }
        
        .export-btn {
            padding: 8px 15px; border-radius: 5px; border: none; 
            color: white; font-weight: bold; cursor: pointer; font-size: 12px;
            display: flex; align-items: center; gap: 5px;
        }
        .btn-csv { background-color: #2e7d32; } /* Green */
        .btn-pdf { background-color: #d32f2f; } /* Red */
    </style>
</head>
<body>

    <header>
        <div class="header-left" onclick="location.href='dashboard.html'" style="cursor: pointer;" title="Back to Dashboard">
            <div class="header-logo"><img src="images/SSGLOGO.png" alt="Logo" onerror="this.style.display='none'"></div>
            <div class="header-title">Supreme Student Government</div>
        </div>
        
        <div class="header-right">
            <div class="profile-icon" onclick="openProfileDrawer()">K</div>
            
            <div id="notificationDropdown" class="notif-dropdown">
                <div class="notif-header">Notifications</div>
                <div class="notif-list" id="notifListContainer"></div>
            </div>

            <div class="header-menu-container">
                <i class="fa-solid fa-bars" id="mainMenuBtn" style="font-size:20px; cursor:pointer; color:white; margin-left:20px;"></i>
                <div class="main-dropdown-menu" id="mainMenu">
                    <div class="menu-item" onclick="toggleNotifications(event)"><i class="fa-regular fa-bell"></i> Notification</div>
                    <div class="menu-item" onclick="location.href='dashboard.html'"><i class="fa-solid fa-house"></i> Feed</div>
                    <div class="menu-item" onclick="location.href='logout.php'"><i class="fa-solid fa-arrow-right-from-bracket"></i> Logout</div>
                    <div class="menu-item" onclick="copyLink()"><i class="fa-solid fa-link"></i> Copy link</div>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <nav class="sidebar">
            <div class="nav-item active" id="navDashboard" onclick="showDashboardView()">
                <i class="fa-solid fa-bookmark"></i> Dashboard
            </div>
            <div class="nav-item" id="navOfficers" onclick="showOfficersView()">
                <i class="fa-solid fa-user-group"></i> Officers
            </div>
            <div class="nav-item" id="navLogs" onclick="showLogsView()">
                <i class="fa-solid fa-clock-rotate-left"></i> Activity Logs
            </div>
        </nav>

        <main class="content-area">
            
            <div id="dashboardView">
                <h1 class="page-title">Dashboard</h1>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon-wrapper"><div class="stat-icon icon-officer"><i class="fa-solid fa-user"></i></div>Total Officers</div><div class="stat-number" id="totalOfficers">0</div></div>
                    <div class="stat-card"><div class="stat-icon-wrapper"><div class="stat-icon icon-login"><i class="fa-solid fa-user-clock"></i></div>Officers Logged-in Today</div><div class="stat-number" id="loggedInCount">0</div></div>
                    <div class="stat-card"><div class="stat-icon-wrapper"><div class="stat-icon icon-msg"><i class="fa-solid fa-envelope"></i></div>Anonymous Message Received</div><div class="stat-number" id="msgCount">0</div></div>
                    <div class="stat-card"><div class="stat-icon-wrapper"><div class="stat-icon icon-event"><i class="fa-solid fa-circle-exclamation"></i></div>Total Event Listed</div><div class="stat-number" id="eventCount">0</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">Message Analytics</div>
                        <div class="chart-wrapper"><canvas id="msgChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Daily Message Trend</div>
                        <div class="chart-wrapper"><canvas id="trendChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="officersView" style="display: none;">
                <h1 class="page-title">Officers</h1>
                
                <div class="search-container">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    <input type="text" id="officerSearch" placeholder="Search officers" onkeyup="filterOfficers()">
                </div>

                <div class="tabs-container">
                    <div class="tab active" id="tabUsers" onclick="switchTab('users')">Users</div>
                    <div class="tab" id="tabPending" onclick="switchTab('pending')">Pending</div>
                    <div class="tab" id="tabRole" onclick="switchTab('role')">Role</div>
                </div>

                <div class="officers-table-container">
                    <table id="officersTable">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Name</th>
                                <th style="width: 25%;">Email</th>
                                <th style="width: 25%;">Position</th>
                                <th style="width: 15%;" id="headerDateColumn">Last Login</th>
                                <th style="width: 15%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="officersTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="logsView" style="display: none;">
                <h1 class="page-title">Activity Logs</h1>
                
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <div class="search-container" style="margin-bottom:0; width:60%;">
                        <i class="fa-solid fa-magnifying-glass search-icon"></i>
                        <input type="text" id="logSearch" placeholder="Search by name, email, or position..." onkeyup="filterLogs()">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="export-btn btn-csv" onclick="exportTableToCSV('activity_logs.csv')"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
                        <button class="export-btn btn-pdf" onclick="window.print()"><i class="fa-solid fa-file-pdf"></i> Export PDF</button>
                    </div>
                </div>

                <div class="officers-table-container"> <table id="logsTable">
                        <thead style="background-color: #a60000;"> <tr>
                                <th style="color:white;">DATE</th>
                                <th style="color:white;">LOGIN TIME</th>
                                <th style="color:white;">LOGOUT TIME</th>
                                <th style="color:white;">FULL NAME</th>
                                <th style="color:white;">POSITION</th>
                                <th style="color:white;">EMAIL</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div class="profile-overlay" id="profileOverlay"></div>
    <div class="profile-drawer" id="profileDrawer">
        <div class="profile-drawer-header">
            <div class="big-profile-icon" id="drawerProfileIcon"><span>K</span></div>
            <div class="edit-profile-link" onclick="document.getElementById('profilePicInput').click()"><i class="fa-solid fa-camera"></i> Change Photo</div>
            <input type="file" id="profilePicInput" accept="image/*" style="display: none;">
        </div>
        <div class="profile-form">
            <div class="form-group"><label>Name:</label><div class="input-wrapper"><input type="text" id="profileNameInput" placeholder="Enter full name"></div></div>
            <div class="form-group"><label>Position:</label><div class="input-wrapper"><input type="text" id="profilePositionInput" placeholder="Enter position"></div></div>
            <div class="form-group"><label>Email:</label><div class="input-wrapper"><input type="email" id="profileEmailInput" placeholder="Enter email"><i class="fa-solid fa-pen input-icon"></i></div></div>
            <div class="form-group"><label>Birthday:</label><div class="input-wrapper"><input type="date" id="profileBirthdayInput"><i class="fa-solid fa-pen input-icon"></i></div></div>
            <div class="drawer-actions"><button class="btn-back" id="closeProfileBtn">Back</button><button class="btn-save" id="saveProfileBtn">Save</button></div>
        </div>
    </div>

    <script>
        // --- 1. SHARED UTILS (Menus & Profile) ---
        function loadHeaderProfile() {
            const btn = document.querySelector('.profile-icon');
            fetch('get_user_profile.php').then(r=>r.json()).then(res=>{
                if(res.success && btn) {
                    if(res.data.profile_pic && res.data.profile_pic!=="default_avatar.png"){
                        btn.innerHTML = `<img src="uploads/${res.data.profile_pic}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                    } else if(res.data.fullname) btn.innerText = res.data.fullname.charAt(0).toUpperCase();
                }
            });
        }

        window.toggleNotifications = function(e) {
            if(e) e.stopPropagation();
            const d = document.getElementById('notificationDropdown');
            document.getElementById('mainMenu').classList.remove('show');
            if(d.classList.contains('show')) d.classList.remove('show');
            else { fetchNotifications(); d.classList.add('show'); }
        };

        function fetchNotifications() {
            fetch('get_notifications.php').then(r=>r.json()).then(data=>{
                const list = document.getElementById('notifListContainer');
                list.innerHTML = "";
                if(data.length===0){ list.innerHTML = "<div style='padding:20px;text-align:center;color:#888;'>No new notifications</div>"; return; }
                data.forEach(n=>{
                    let ic='icon-msg', ih='<i class="fa-solid fa-shield-halved"></i>';
                    if(n.type==='event') { ic='icon-evt'; ih = (n.profile_pic) ? `<img src="uploads/${n.profile_pic}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : `<span>${n.fullname?n.fullname[0]:'U'}</span>`; }
                    list.insertAdjacentHTML('beforeend', `<div class="notif-item"><div class="notif-icon ${ic}">${ih}</div><div class="notif-content"><div class="notif-text">${n.text}</div><div class="notif-time">${n.time_ago}</div></div></div>`);
                });
            });
        }

        // Profile Logic
        const pDrawer=document.getElementById('profileDrawer'), pOverlay=document.getElementById('profileOverlay');
        const pName=document.getElementById('profileNameInput'), pPos=document.getElementById('profilePositionInput');
        const pEmail=document.getElementById('profileEmailInput'), pBirth=document.getElementById('profileBirthdayInput');
        const pIcon=document.getElementById('drawerProfileIcon'), pFile=document.getElementById('profilePicInput');

        window.openProfileDrawer=()=>{
            pDrawer.classList.add('open'); pOverlay.classList.add('open');
            fetch('get_user_profile.php').then(r=>r.json()).then(res=>{
                if(res.success){
                    pName.value=res.data.fullname||""; pPos.value=res.data.position||""; pEmail.value=res.data.email||""; pBirth.value=res.data.birthday||"";
                    if(res.data.profile_pic && res.data.profile_pic!=="default_avatar.png") pIcon.innerHTML=`<img src="uploads/${res.data.profile_pic}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                    else pIcon.innerText=res.data.fullname?res.data.fullname[0].toUpperCase():"U";
                }
            });
        };
        window.closeProfileDrawer=()=>{ pDrawer.classList.remove('open'); pOverlay.classList.remove('open'); };
        
        if(pFile) pFile.addEventListener('change', function(){
            if(this.files[0]){ const r=new FileReader(); r.onload=function(e){pIcon.innerHTML=`<img src="${e.target.result}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;}; r.readAsDataURL(this.files[0]); }
        });

        document.getElementById('saveProfileBtn').addEventListener('click', function(){
            const btn=this; btn.innerText="Saving...";
            const fd=new FormData(); fd.append('fullname',pName.value); fd.append('position',pPos.value); fd.append('email',pEmail.value); fd.append('birthday',pBirth.value);
            if(pFile.files[0]) fd.append('profile_pic',pFile.files[0]);
            fetch('update_user_profile.php', {method:'POST', body:fd}).then(r=>r.json()).then(res=>{
                btn.innerText="Save"; if(res.success){ alert("Updated!"); loadHeaderProfile(); closeProfileDrawer(); } else alert(res.error);
            });
        });
        document.getElementById('closeProfileBtn').addEventListener('click', closeProfileDrawer);
        pOverlay.addEventListener('click', closeProfileDrawer);

        // Menu Toggle
        document.getElementById('mainMenuBtn').addEventListener('click', (e)=>{ e.stopPropagation(); document.getElementById('mainMenu').classList.toggle('show'); });
        window.addEventListener('click', ()=>{ 
            document.getElementById('mainMenu').classList.remove('show'); 
            document.getElementById('notificationDropdown').classList.remove('show');
        });

        function copyLink() {
            const url = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1) + "anonymous-message.html";
            navigator.clipboard.writeText(url).then(()=>alert("Link copied!")).catch(e=>console.error(e));
        }


        // --- 2. ANALYTICS LOGIC (Dashboard View) ---
        async function fetchAnalytics() {
            try {
                const response = await fetch('get_analytics.php');
                const data = await response.json();
                document.getElementById('totalOfficers').innerText = data.total_officers;
                document.getElementById('loggedInCount').innerText = data.logged_in_today;
                document.getElementById('msgCount').innerText = data.total_messages;
                document.getElementById('eventCount').innerText = data.total_events;
                renderMsgChart(data.message_breakdown);
                renderTrendChart(data.daily_trend);
            } catch (error) { console.error("Analytics Error:", error); }
        }

        function renderMsgChart(stats) {
            const ctx = document.getElementById('msgChart').getContext('2d');
            new Chart(ctx, { type: 'doughnut', data: { labels: ['Complaints', 'Concerns', 'Queries'], datasets: [{ data: [stats.Complaint, stats.Concern, stats.Query], backgroundColor: ['#e53935', '#fb8c00', '#fdd835'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
        }

        function renderTrendChart(trendData) {
            if (!trendData || trendData.length === 0) trendData = [{date: 'Today', count: 0}];
            const labels = trendData.map(i => i.date);
            const data = trendData.map(i => i.count);
            const ctx = document.getElementById('trendChart').getContext('2d');
            new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Messages', data: data, borderColor: '#cf6828', backgroundColor: 'rgba(207, 104, 40, 0.1)', borderWidth: 3, pointBackgroundColor: '#960b15', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } }, x: { grid: { display: false } } } } });
        }


        // ==========================================
        // 3. OFFICERS & USERS LOGIC (UPDATED)
        // ==========================================
        
        let currentTab = 'users'; // 'users' or 'pending' or 'role'

        function switchTab(tabName) {
            currentTab = tabName;

            // 1. Visual Update (Tabs)
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if(tabName === 'users') document.getElementById('tabUsers').classList.add('active');
            if(tabName === 'pending') document.getElementById('tabPending').classList.add('active');
            if(tabName === 'role') document.getElementById('tabRole').classList.add('active');

            // --- NEW: CHANGE TABLE HEADER TEXT ---
            const dateHeader = document.getElementById('headerDateColumn');
            if (tabName === 'pending') {
                dateHeader.innerText = "Created"; // Show 'Created' for pending
            } else {
                dateHeader.innerText = "Last Login"; // Show 'Last Login' for active users
            }
            // -------------------------------------

            // 2. Fetch Data
            fetchUsersList();
        }

        async function fetchUsersList() {
            try {
                // Call the new PHP script with the tab filter
                const response = await fetch(`get_users_list.php?tab=${currentTab}`);
                const users = await response.json();
                
                renderUserTable(users);
            } catch (e) { console.error(e); }
        }

        function renderUserTable(users) {
            const tbody = document.getElementById('officersTableBody');
            tbody.innerHTML = "";

            if (users.length === 0) {
                tbody.innerHTML = `<tr><td colspan='5' style='text-align:center; color:#888; padding:20px;'>No ${currentTab} records found.</td></tr>`;
                return;
            }

            users.forEach(user => {
                let actionBtns = '';
                let statusText = '';
                let roleHtml = `<span style="text-transform:capitalize;">${user.role}</span>`; // Default Text

                // --- BUILD ROW CONTENT BASED ON TAB ---
                if (currentTab === 'pending') {
                    // Pending Tab
                    statusText = `<span style="color:#e65100; font-size:12px;">Registered: ${user.created_at_text}</span>`;
                    actionBtns = `
                        <button onclick="approveUser(${user.user_id})" style="background:#4caf50; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; margin-right:5px;">Approve</button>
                        <button onclick="removeOfficer(${user.user_id})" style="background:#ef5350; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">Decline</button>
                    `;
                } 
                else if (currentTab === 'role') {
                    // Role Tab: Show Dropdown
                    statusText = user.last_login_text;
                    
                    // Logic to select the current role
                    const isAdmin = user.role === 'admin' ? 'selected' : '';
                    const isOfficer = user.role === 'officer' ? 'selected' : '';

                    // The logic here is: Replace text with Dropdown
                    roleHtml = `
                    <select onchange="updateRole(${user.user_id}, this.value)" style="padding:5px; border-radius:4px; border:1px solid #ccc;">
                        <option value="officer" ${isOfficer}>Officer</option>
                        <option value="admin" ${isAdmin}>Admin</option>
                    </select>`;
                    
                    actionBtns = `<span style="color:#888; font-size:12px;">Auto-saves</span>`;
                } 
                else {
                    // Users Tab (Default)
                    statusText = user.last_login_text;
                    actionBtns = `<button class="btn-remove" onclick="removeOfficer(${user.user_id})">Remove</button>`;
                }

                // Note: We use the 4th column for BOTH "Last Login" and "Role HTML" logic depending on the tab
                // But wait, the table has 5 columns. 
                // Col 1: Name, Col 2: Email, Col 3: Position, Col 4: Last Login/Created, Col 5: Actions
                // Where does 'Role' go? 
                
                // FIX: If we are in the 'role' tab, we can repurpose the 'Position' column or add a new one. 
                // BUT better yet, let's just REPLACE the Position text with the Role Dropdown in the 'Role' tab to keep it simple?
                // OR, we can just insert the role dropdown into the 'Last Login' column?
                
                // Let's stick to the 5-column structure:
                // 1. Name
                // 2. Email
                // 3. Position (stays position)
                // 4. Last Login (or Role Dropdown if in role tab?)
                
                // ACTUALLY, usually Role Management is its own column. 
                // Since we have limited columns, let's put the Role Dropdown in the 4th column (replacing Last Login) when in Role Tab.
                
                let col4Content = statusText;
                if(currentTab === 'role') {
                    col4Content = roleHtml;
                    // Also update header text to 'Role'
                    document.getElementById('headerDateColumn').innerText = "Role";
                }

                const row = `
                <tr>
                    <td style="font-weight:500;">${user.fullname}</td>
                    <td>${user.email}</td>
                    <td>${user.position}</td>
                    <td>${col4Content}</td> 
                    <td>${actionBtns}</td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });

            for(let i=0; i<3; i++) tbody.insertAdjacentHTML('beforeend', '<tr class="empty-row"><td colspan="5"></td></tr>');
        }

        // --- NEW: UPDATE ROLE FUNCTION ---
        async function updateRole(id, newRole) {
            try {
                const response = await fetch('update_user_role.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, role: newRole })
                });
                const result = await response.json();
                
                if(result.success) {
                    console.log("Role updated to " + newRole);
                } else {
                    alert("Error updating role: " + result.error);
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        // --- ACTIONS ---

        async function approveUser(id) {
            if(!confirm("Approve this user?")) return;
            
            fetch('approve_user.php', { 
                method: 'POST', 
                headers: {'Content-Type':'application/json'}, 
                body: JSON.stringify({id:id}) 
            })
            .then(r=>r.json())
            .then(res=>{ 
                if(res.success) fetchUsersList(); // Refresh table
                else alert(res.error); 
            });
        }

        async function removeOfficer(id) {
            // 1. Confirm before deleting
            if(!confirm("Are you sure you want to remove this user?")) return;

            // 2. Send request to PHP
            fetch('remove_officer.php', { 
                method: 'POST', 
                headers: {'Content-Type':'application/json'}, 
                body: JSON.stringify({id:id}) 
            })
            .then(response => response.json())
            .then(data => { 
                if(data.success) {
                    alert("User removed successfully.");
                    // 3. Refresh the table
                    fetchUsersList();
                } else {
                    alert("Error: " + data.error); 
                }
            })
            .catch(err => console.error(err));
        }

        // --- FILTER SEARCH ---
        function filterOfficers() {
            const filter = document.getElementById('officerSearch').value.toLowerCase();
            const rows = document.getElementById("officersTable").getElementsByTagName("tr");
            for (let i = 1; i < rows.length; i++) {
                let name = rows[i].getElementsByTagName("td")[0];
                let email = rows[i].getElementsByTagName("td")[1];
                if (name || email) {
                    let txt = (name.textContent + email.textContent).toLowerCase();
                    rows[i].style.display = txt.indexOf(filter) > -1 ? "" : "none";
                }
            }
        }


        // --- NAVIGATION SWITCHER (FIXED) ---
        function showDashboardView() {
            document.getElementById('dashboardView').style.display = 'block';
            document.getElementById('officersView').style.display = 'none';
            document.getElementById('logsView').style.display = 'none'; // FIX: Hide Logs
            
            document.getElementById('navDashboard').classList.add('active');
            document.getElementById('navOfficers').classList.remove('active');
            document.getElementById('navLogs').classList.remove('active');
            
            fetchAnalytics(); 
        }

        function showOfficersView() {
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('officersView').style.display = 'block';
            document.getElementById('logsView').style.display = 'none'; // FIX: Hide Logs
            
            document.getElementById('navDashboard').classList.remove('active');
            document.getElementById('navOfficers').classList.add('active');
            document.getElementById('navLogs').classList.remove('active');
            
            fetchUsersList(); 
        }
        
        function showLogsView() {
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('officersView').style.display = 'none';
            document.getElementById('logsView').style.display = 'block';
            
            document.getElementById('navDashboard').classList.remove('active');
            document.getElementById('navOfficers').classList.remove('active');
            document.getElementById('navLogs').classList.add('active');
            
            fetchLogs(); 
        }

        // Init
        window.onload = function() {
            loadHeaderProfile();
            fetchAnalytics(); // Default view
        };

        // --- 4. LOGS LOGIC ---
        async function fetchLogs() {
            try {
                const response = await fetch('get_activity_logs.php');
                const logs = await response.json();
                
                const tbody = document.getElementById('logsTableBody');
                tbody.innerHTML = "";

                if (logs.length === 0) {
                    tbody.innerHTML = `<tr><td colspan='6' style='text-align:center; padding:20px;'>No activity logs found.</td></tr>`;
                    return;
                }

                logs.forEach(log => {
                    const row = `
                    <tr>
                        <td style="font-weight:bold;">${log.date}</td>
                        <td>${log.time}</td>
                        <td>${log.logout_time}</td>
                        <td>${log.fullname}</td>
                        <td>${log.position}</td>
                        <td>${log.email}</td>
                    </tr>`;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            } catch (e) { console.error(e); }
        }

        // CSV Export Function
        function exportTableToCSV(filename) {
            const csv = [];
            const rows = document.querySelectorAll("#logsTable tr");
            
            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll("td, th");
                for (let j = 0; j < cols.length; j++) 
                    row.push(cols[j].innerText);
                csv.push(row.join(","));        
            }

            const csvFile = new Blob([csv.join("\n")], {type: "text/csv"});
            const downloadLink = document.createElement("a");
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
        }

        // Filter Function
        function filterLogs() {
            const filter = document.getElementById('logSearch').value.toLowerCase();
            const rows = document.getElementById("logsTableBody").getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                let text = rows[i].innerText.toLowerCase();
                rows[i].style.display = text.indexOf(filter) > -1 ? "" : "none";
            }
        }

        // --- NAVIGATION UPDATE ---
        function showLogsView() {
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('officersView').style.display = 'none';
            document.getElementById('logsView').style.display = 'block'; // Show Logs
            
            document.getElementById('navDashboard').classList.remove('active');
            document.getElementById('navOfficers').classList.remove('active');
            document.getElementById('navLogs').classList.add('active'); // Activate Tab
            
            fetchLogs(); // Load Data
        }
        
        // Update other show functions to hide logsView
        // e.g. inside showDashboardView(): document.getElementById('logsView').style.display = 'none';
    </script>
</body>
</html>